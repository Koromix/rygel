- name: Install packages
  package:
    update_cache: yes
    pkg:
      - nginx
      - git
      - gcc
      - g++
      - python3-jinja2
      - runc
    state: latest
  become: yes

- name: Create Goupile user
  user:
    name: goupile
    create_home: no
    home: /nonexistent
    shell: /usr/sbin/nologin
    system: yes
  register: goupile_user
  become: yes

- name: Prepare Goupile directories
  file:
    path: '{{item.path}}'
    state: directory
    owner: '{{item.owner}}'
    mode: '0755'
  loop:
    - path: '{{goupile_root_path}}'
      owner: root
    - path: '{{goupile_root_path}}/repo'
      owner: '{{ansible_user_id}}'
    - path: '{{goupile_root_path}}/containers'
      owner: root
    - path: '{{goupile_root_path}}/nginx/domains.d'
      owner: root
    - path: '{{goupile_root_path}}/sync'
      owner: root
  become: yes

- name: Fetch Goupile repository
  git:
    repo: https://framagit.org/interhop/goupile.git
    dest: '{{goupile_root_path}}/repo'
  become: no

- name: Update Felix build system
  command:
    cmd: '{{goupile_root_path}}/repo/bin/felix -O {{goupile_root_path}}/repo/bin {{goupile_build_options}} felix'
    chdir: '{{goupile_root_path}}/repo'
  ignore_errors: yes
  register: build_felix
  changed_when: 'not build_felix.failed and build_felix.stderr_lines[-1] != "Nothing to do!" and build_felix.stderr_lines[-2] != "Nothing to do!"'
  become: no

- name: Bootstrap Felix
  block:
    - name: Bootstrap Felix
      shell:
        cmd: '{{goupile_root_path}}/repo/bootstrap.sh'
        chdir: '{{goupile_root_path}}/repo'
    - name: Update Felix build system
      command:
        cmd: '{{goupile_root_path}}/repo/felix -O {{goupile_root_path}}/repo/bin {{goupile_build_options}} felix'
        chdir: '{{goupile_root_path}}/repo'
    - name: Delete bootstrapped Felix
      file:
        path: '{{goupile_root_path}}/repo/felix'
        state: absent
  when: 'not ansible_check_mode and build_felix.rc != 0'
  become: no

- name: Build Goupile
  command:
    cmd: '{{goupile_root_path}}/repo/bin/felix -O {{goupile_root_path}}/repo/bin {{goupile_build_options}} goupile felix'
    chdir: '{{goupile_root_path}}/repo'
  register: build_goupile
  changed_when: 'build_goupile.stderr_lines[-1] != "Nothing to do!" and build_goupile.stderr_lines[-2] != "Nothing to do!"'
  become: no

- name: Install Goupile
  copy:
    src: '{{item.src}}'
    remote_src: yes
    dest: '{{item.dest}}'
    owner: root
    group: root
    mode: '0755'
  loop:
    - src: '{{goupile_root_path}}/repo/bin/goupile'
      dest: '{{goupile_root_path}}/goupile'
    - src: '{{goupile_root_path}}/repo/build/goupile/server/sync.py'
      dest: '{{goupile_root_path}}/sync/sync.py'
  become: yes

- name: Update configuration files
  template:
    src: '{{item.src}}'
    dest: '{{item.dest}}'
    owner: root
    group: root
    mode: '{{item.mode}}'
  loop:
    - src: sync.ini.j2
      dest: '{{goupile_root_path}}/sync/sync.ini'
      mode: '0600'
    - src: bundle.json.j2
      dest: '{{goupile_root_path}}/sync/bundle.json'
      mode: '0644'
    - src: goupile@.service.j2
      dest: /etc/systemd/system/goupile@.service
      mode: '0644'
  register: upload_config
  become: yes

- name: Write NGINX template file
  copy:
    src: nginx.conf.j2
    dest: '{{goupile_root_path}}/sync/nginx.conf.j2'
    owner: root
    group: root
    mode: '0644'
  become: yes

- name: Add NGINX include file
  copy:
    content: 'include {{goupile_root_path}}/nginx/domains.d/*.conf;'
    dest: '{{nginx_conf_path}}/goupile.conf'
    owner: root
    group: root
    mode: '0644'
  become: yes

- name: Reload systemd units
  systemd:
    daemon_reload: yes
  when: upload_config.changed
  become: yes

- name: Enable and start NGINX
  systemd:
    name: '{{nginx_service_name}}'
    enabled: yes
    state: started
  become: yes

- name: Sync Goupile, NGINX and systemd
  command:
    cmd: '{{goupile_root_path}}/sync/sync.py'
  register: sync
  changed_when: 'sync.stderr_lines[-1] != ">>> Nothing has changed" and sync.stderr_lines[-2] != ">>> Nothing has changed"'
  become: yes
