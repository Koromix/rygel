- name: Get connected user name
  command: whoami
  changed_when: no
  register: whoami
  become: no

- name: Install packages
  package:
    update_cache: yes
    pkg:
      - nginx
      - git
      - gcc
      - g++
    state: latest
  become: yes

- name: Create Goupile user
  user:
    name: goupile
    create_home: no
    home: /nonexistent
    shell: /usr/sbin/nologin
    system: yes
  become: yes

- name: Prepare Goupile directories
  file:
    path: '{{item.path}}'
    state: 'directory'
    owner: '{{item.owner}}'
    mode: '0755'
  loop:
    - path: '{{goupile_root_path}}'
      owner: 'root'
    - path: '{{goupile_root_path}}/src'
      owner: '{{whoami.stdout}}'
    - path: '{{goupile_root_path}}/domains'
      owner: '{{goupile_run_user}}'
    - path: '{{goupile_root_path}}/nginx/domains.d'
      owner: 'root'
  become: yes

- name: Fetch Goupile repository
  git:
    repo: https://framagit.org/interhop/goupile.git
    dest: '{{goupile_root_path}}/src'
  become: no

- name: Update Felix build system
  command:
    cmd: '{{goupile_root_path}}/src/bin/{{goupile_compiler}}_Fast/felix -c{{goupile_compiler}} -mFast felix'
    chdir: '{{goupile_root_path}}/src'
  ignore_errors: yes
  register: felix_update
  become: no

- name: Bootstrap Felix
  block:
    - name: 'Bootstrap Felix'
      shell:
        cmd: '{{goupile_root_path}}/src/build/felix/build_posix.sh'
        chdir: '{{goupile_root_path}}/src'
    - name: Update Felix build system
      command:
        cmd: '{{goupile_root_path}}/src/felix -c{{goupile_compiler}} -mFast felix'
        chdir: '{{goupile_root_path}}/src'
    - name: Delete bootstrapped Felix
      file:
        path: '{{goupile_root_path}}/src/felix'
        state: 'absent'
  when: 'felix_update.rc != 0'
  become: no

- name: Build Goupile
  command:
    cmd: '{{goupile_root_path}}/src/bin/{{goupile_compiler}}_Fast/felix -c{{goupile_compiler}} -mFast goupile'
    chdir: '{{goupile_root_path}}/src'
  register: build_goupile
  changed_when: 'build_goupile.stderr_lines[-1] != "Nothing to do!" and build_goupile.stderr_lines[-2] != "Nothing to do!"'
  become: no

- name: Install Goupile
  copy:
    src: '{{item.src}}'
    remote_src: yes
    dest: '{{item.dest}}'
    owner: 'root'
    group: 'root'
    mode: '0755'
  loop:
    - src: '{{goupile_root_path}}/src/bin/{{goupile_compiler}}_Fast/goupile'
      dest: '{{goupile_root_path}}/goupile'
    - src: '{{goupile_root_path}}/src/build/goupile/server/sync.py'
      dest: '{{goupile_root_path}}/sync.py'
  become: yes

- name: Upload configuration files
  template:
    src: '{{item.src}}'
    dest: '{{item.dest}}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  loop:
    - src: sync.ini.j2
      dest: '{{goupile_root_path}}/sync.ini'
    - src: goupile@.service.j2
      dest: /etc/systemd/system/goupile@.service
    - src: include.conf.j2
      dest: '{{goupile_root_path}}/nginx/include.conf'
  register: upload_config
  become: yes

- name: Reload systemd units
  systemd:
    daemon_reload: yes
  when: upload_config.changed
  become: yes

- name: Enable and start NGINX
  systemd:
    name: 'nginx'
    enabled: yes
    state: 'started'
  become: yes

- name: Sync Goupile, NGINX and systemd
  command:
    cmd: '{{goupile_root_path}}/sync.py'
  become: yes
