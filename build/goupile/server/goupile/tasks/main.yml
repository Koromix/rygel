- name: Get connected user name
  command: whoami
  changed_when: false
  register: whoami
  become: false

- name: Install packages (apt)
  apt:
    update_cache: yes
    pkg:
      - nginx
      - git
      - gcc
      - g++
    state: latest
  become: yes
  when: 'ansible_os_family == "Debian"'

- name: Install packages (yum)
  yum:
    update_cache: yes
    pkg:
      - nginx
      - git
      - gcc
      - g++
    state: latest
  become: yes
  when: 'ansible_os_family == "RedHat"'

- name: Create Goupile user
  user:
    name: goupile
    create_home: no
    home: /nonexistent
    shell: /usr/sbin/nologin
    system: yes
  become: yes

- name: Prepare Goupile directories
  file:
    path: '{{item.path}}'
    state: 'directory'
    owner: '{{item.owner}}'
    mode: '0755'
  loop:
    - path: '{{goupile_root}}'
      owner: 'root'
    - path: '{{goupile_root}}/src'
      owner: '{{whoami.stdout}}'
    - path: '{{goupile_root}}/domains'
      owner: 'goupile'
    - path: '{{goupile_root}}/nginx/domains.d'
      owner: 'root'
  become: yes

- name: Fetch Goupile repository
  git:
    repo: https://framagit.org/interhop/goupile.git
    dest: '{{goupile_root}}/src'
  become: no

- name: Bootstrap Felix
  shell:
    cmd: '{{goupile_root}}/src/build/felix/build_posix.sh'
    creates: '{{goupile_root}}/src/felix'
    chdir: '{{goupile_root}}/src'
  become: no

- name: Build Goupile
  command:
    cmd: '{{goupile_root}}/src/felix -cGCC -mFast goupile'
    chdir: '{{goupile_root}}/src'
  register: build
  changed_when: 'build.stderr_lines[-1] == "Nothind to do!" or build.stderr_lines[-2] == "Nothind to do!"'
  become: no

- name: Install Goupile
  copy:
    src: '{{item.src}}'
    remote_src: yes
    dest: '{{item.dest}}'
    owner: 'root'
    group: 'root'
    mode: '0755'
  loop:
    - src: '{{goupile_root}}/src/bin/GCC_Fast/goupile'
      dest: '{{goupile_root}}/goupile'
    - src: '{{goupile_root}}/src/build/goupile/server/sync.py'
      dest: '{{goupile_root}}/sync.py'
  become: yes

- name: Upload configuration files
  copy:
    src: '{{item.src}}'
    dest: '{{item.dest}}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  loop:
    - src: sync.ini
      dest: '{{goupile_root}}/sync.ini'
    - src: goupile@.service
      dest: /etc/systemd/system/goupile@.service
    - src: include.conf
      dest: '{{goupile_root}}/nginx/include.conf'
  register: configuration
  become: yes

- name: Reload systemd units
  systemd:
    daemon_reload: yes
  when: configuration.changed
  become: yes

- name: Enable and start NGINX
  systemd:
    name: 'nginx'
    enabled: yes
    state: 'started'
  become: yes

- name: Sync Goupile, NGINX and systemd
  command:
    cmd: '{{goupile_root}}/sync.py'
  become: yes
