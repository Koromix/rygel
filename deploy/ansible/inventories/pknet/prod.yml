all:
  hosts:
    host1:
      ansible_host: 141.95.19.234
      ansible_port: 22
      ansible_user: ansible
      ansible_ssh_private_key_file: ~/.ssh/pknet/prod
      ansible_python_interpreter: /usr/bin/python3

      ovh_ipv6_addr: 2001:41d0:701:1100::3f69
      ovh_ipv6_netmask: 128
      ovh_ipv6_gateway: 2001:41d0:701:1100::1

      nginx_public_addr: '{{ ansible_host }}'
      nginx_domains:
        - name: '{{ prometheus_public_addr }}'
          config: |
            ssl_client_certificate /opt/nginx/ssl/internal/ca.crt;
            ssl_verify_client on;
            ssl_verify_depth 2;

            {% for exporter in prometheus_exporters %}

            location /metrics/{{ exporter }} {
                allow {{ hostvars.monitor.nginx_public_addr }};
                deny all;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:{{ prometheus_packages[exporter].port }}/metrics;
            }
            {% endfor %}
        - name: anesth-lille.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/anesth-lille.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'
        - name: cn2r.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/cn2r.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'
        - name: medita.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/medita.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'
        - name: psy-lille.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/psy-lille.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'

      goupile_commit: deploy_pknet
      goupile_sandbox: no
      goupile_domains:
        - name: anesth-lille.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            65313431633061336531636236306365626665306462623236393238306335353232316332306238
            3536613461393765303836616266306233633436623961300a323839656138663664626633623238
            33373964323330333264326433313134373731613738376632386565636235616238386166323831
            3935306633303939370a653634326639303363343361636463306163323561356334646630383434
            64656163323338376465396135333662636134663639643964386134643661313638346134656635
            3766646561383232396531663862656334376635616238323835
        - name: cn2r.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62633335383133616536313666363164646130653934353033366465623832623932303263616264
            3138633737646462356661633963303338313061363162610a346532323234316139333931366131
            32613066383166343163346366626263613630356663663061616432643235623437326534306235
            6238383166356339320a346534373435393161336338663536393837383161633236643633653531
            62326434306363663662363333393732366561396134346133636432666532336365376366653432
            6138393832623033366435383932643432356566313037323931
        - name: medita.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38393961616130386130363539313035613837616165633464306566346137636135393436646536
            3437316232356162323066646433353266393534306231340a636439643164633630333734636536
            31663638386537656434363538623130313234376636353030346134363834363461623537616132
            3433656462356232350a336530303461323861326534646632623930626664646334356666326637
            37323136653231383763366635383564646535373664396330376133316662316463313631393736
            3362616562666432393338356130653864646536663437386631
        - name: psy-lille.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            64383633646566303434363332396434353063653534303065343834333562643436613836383237
            3665666666386362363533663333613462363030663731660a643061303361656633313131393239
            34303161343564383862643362353561346464613438643566313035306539653562313331663933
            6634343130306163370a346332643864383232386139653437373265376263353837633934356564
            36303962383637333462316364353761336633343630376338363037313364303832366163366661
            3030346331653532343663633935613332316135363461313839
      goupile_default_username: admin
      goupile_default_password: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        34636236643063366163643862626661303264373662376361303837386133383930613362326161
        3331333464643034346466656438383535303461303431650a366262363231626466646438343532
        63626233646666313234353665616433386362616538633339303363333466333934663930653463
        3034363236366438340a373564336135393264636533313464323061356364616361383935393436
        33323139353761396134363130316631633235333761316336613331353132646539
      goupile_smtp:
        url: smtps://mail.gandi.net
        username: noreply@goupile.fr
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30653635353232623035383761656434386562636137613363643635623863656631363363333465
          6566353165653362646363356438626634306330373537360a333366663234313365626463363435
          38616531393632643439363831303563333965396437373834626265353834313430386137363630
          3461323164643435610a336463633930396336613165623139353635376237373831616563653861
          66623264356136343266383135393135653235396165646333336362313931663633
        from: noreply@goupile.fr
      goupile_sms:
        provider: Twilio
        auth_id: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30383036343963313638383266663461373365383138303764613831636230353164373432393839
          6337646336336265343532656561653665333830366565380a653336306164393363383036333430
          32333533356131333865383339336561346139393561663664343461366264353561333763666562
          3433316432353739660a326264383939623737636661623363313534303537623865303137313164
          65633262363039616231323033313164396562633932306161613564326162666230316264646332
          3762343337333933643736626531653236333336363239663433
        auth_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39643532643563313035646233653334373063393934346332646331303732393434373339303966
          3134633530393636313963386565653062616539346261310a313432653536306134393831363661
          32666639656136336638343332386235363939366239623765616239363435376533353033383635
          3665363930336330330a306138326638653535303062613330646164623338636434643336663036
          65326538383062373766396361343234613339313339373737393466333434613332643235386337
          3566346639646238366136333566626531383166303838653465
        from: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61656164316566633739646336636262363065643662643536313934373236616131313466616564
          3331356237353565616135333036393936323133643633320a616234396335396662613533356163
          65303237633438353139623564633436393266326530326532333830656136623165363862333839
          3831306332653033610a626432303566353532333865636133346665353335653833643237363061
          3536

      prometheus_public_addr: '{{ ansible_host }}'
      prometheus_exporters:
        - node_exporter
        - nginx_exporter

      borg_public_addr: '{{ ansible_host }}'
      borg_passphrase: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        39383632613037383762363338363336653561306439376330643533616663363435633865363930
        3832656133373739343565343261313266333034343031610a636232396435346131346335646566
        62646531353435373931613361666362336238336639373462663030323330386330626566636434
        6466353137316463310a383339333165323635313763373864396263396239383665653062643339
        64616136623334303763353764386633613131666136303636653236633333363965323162333862
        35323636643738663664346263643061383238383165316534353465353336366433616634336366
        36396133376430306635306335333664616663656534613165343564346334616638353536393539
        32643033326238386663

    backup:
      ansible_host: 46.226.106.221
      ansible_port: 22
      ansible_user: ansible
      ansible_ssh_private_key_file: ~/.ssh/pknet/prod
      ansible_python_interpreter: /usr/bin/python3

      nginx_public_addr: '{{ ansible_host }}'
      nginx_domains:
        - name: '{{ prometheus_public_addr }}'
          config: |
            ssl_client_certificate /opt/nginx/ssl/internal/ca.crt;
            ssl_verify_client on;
            ssl_verify_depth 2;

            {% for exporter in prometheus_exporters %}

            location /metrics/{{ exporter }} {
                allow {{ hostvars.monitor.nginx_public_addr }};
                deny all;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:{{ prometheus_packages[exporter].port }}/metrics;
            }
            {% endfor %}

      prometheus_public_addr: '{{ ansible_host }}'
      prometheus_exporters:
        - node_exporter
        - nginx_exporter

      borg_public_addr: '{{ ansible_host }}'
      borg_server: yes

    monitor:
      ansible_host: 46.226.106.128
      ansible_port: 22
      ansible_user: ansible
      ansible_ssh_private_key_file: ~/.ssh/pknet/prod
      ansible_python_interpreter: /usr/bin/python3

      nginx_public_addr: '{{ ansible_host }}'
      nginx_domains:
        - name: '{{ prometheus_public_addr }}'
          config: |
            ssl_client_certificate /opt/nginx/ssl/internal/ca.crt;
            ssl_verify_client on;
            ssl_verify_depth 2;

            {% for exporter in prometheus_exporters %}

            location /metrics/{{ exporter }} {
                allow {{ hostvars.monitor.nginx_public_addr }};
                deny all;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:{{ prometheus_packages[exporter].port }}/metrics;
            }
            {% endfor %}
        - name: monitor.volpil.fr
          ssl_certbot_email: niels.martignene@protonmail.com
          config: |
            limit_req zone=default burst=100 nodelay;

            location /prometheus {
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:9090;
            }

            location / {
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:9200;
            }
        - name: volpil.fr
          ssl_certbot_email: niels.martignene@protonmail.com
          config: |
            location / {
                index index.html;

                rewrite ^(/?[a-zA-Z0-9]+)$ $1.html;
                rewrite ^(/?[a-zA-Z0-9]+)/$ $1 permanent;
                try_files $uri $uri/ =404;

                root /opt/static/live/goupile.fr;
            }
        - name: www.volpil.fr
          ssl_certbot_email: niels.martignene@protonmail.com
          config: |
            location / {
                return 301 https://volpil.fr$request_uri;
            }

      prometheus_public_addr: '{{ ansible_host }}'
      prometheus_exporters:
        - node_exporter
        - nginx_exporter
      prometheus_url: 'https://monitor.volpil.fr/prometheus'
      grafana_url: 'https://monitor.volpil.fr/'

      static_deploys:
        - name: goupile.fr
          repo: https://framagit.org/interhop/goupile
          path: web/goupile.fr
