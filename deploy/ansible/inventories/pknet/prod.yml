all:
  hosts:
    host1:
      ansible_host: 141.95.19.234
      ansible_port: 22
      ansible_user: ansible
      ansible_ssh_private_key_file: ~/.ssh/pknet/prod
      ansible_python_interpreter: /usr/bin/python3

      ovh_ipv6_addr: 2001:41d0:701:1100::3f69
      ovh_ipv6_netmask: 128
      ovh_ipv6_gateway: 2001:41d0:701:1100::1

      nginx_public_addr: '{{ ansible_host }}'
      nginx_domains:
        - name: '{{ prometheus_public_addr }}'
          config: |
            ssl_client_certificate /opt/nginx/ssl/internal/ca.crt;
            ssl_verify_client on;
            ssl_verify_depth 2;

            {% for exporter in prometheus_exporters %}

            location /metrics/{{ exporter }} {
                allow {{ hostvars.monitor.nginx_public_addr }};
                deny all;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:{{ prometheus_packages[exporter].port }}/metrics;
            }
            {% endfor %}
        - name: anesth-lille.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/anesth-lille.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'
        - name: cn2r.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/cn2r.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'
        - name: medita.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/medita.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'
        - name: psy-lille.goupile.fr
          config: |
            location / {
                proxy_http_version 1.1;
                proxy_request_buffering off;
                proxy_buffering off;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://unix:/run/goupile/psy-lille.goupile.fr.sock:;
            }
          ssl_public_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/fullchain.pem'
          ssl_private_key: '{{ playbook_dir }}/inventories/pknet/goupile.fr/privkey.pem'

      goupile_commit: deploy_pknet
      goupile_sandbox: no
      goupile_domains:
        - name: anesth-lille.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            32323730623935316332306663346465613433313237643665373066396636653538623431303030
            3132363332636136613834333931646264343039643263380a333533653765323364656439333732
            37323964303036343332623233316536386364303031373338376134373938323437306235303537
            3065653563363964370a393337636661336663373266333337613863356163353236383839346463
            33306537363233646534613435373034623830323366383732373931616466346332636531356135
            6131383634643465336465613438386334333265363835303430
        - name: cn2r.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            36643736633237636536343761353263326431383635306433636433666666353239616238363633
            6562303963616637383638636430303435376331623162610a303331626631346434353032353636
            33326232313365633462633363313736623863336135346162613436663234323636663535653663
            3165616137343532340a616465333339613466333430323330363135656435336635643366313364
            63323838313166396165663839353064636538663536616238646265666533323838346231636331
            3034393331333163366363323035313466656430346265386161
        - name: medita.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            64356337386430643235373337393838396139363663643164376466633030363163666266303534
            3639613836616239343330663465636638363464653063390a373332373539343234353437303136
            63313666633463386362636434366131316331333763336362313139633137656463636665623561
            6437363239366234630a663262323763333630343363366636383962356336656334643531323735
            65653263636236373631356232656565623164616439303337613532393835396131643433306632
            3062396235663361346538373234336133373564633533383138
        - name: psy-lille.goupile.fr
          backup_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            64616133313638376337646636313131353433643533343633383565333736323763313366343564
            3532393239386533356666303063363939663933356462390a613734323037333839653733663762
            34646638656263633634336136386164656164393064653436656363313162343237666537633665
            6562373064366135610a346336663336336164386139363730333839633733366635666138633032
            66363262373937616338663961663239353333313564313531393763393939373637373633363133
            6161663962383565386364653434393532373535323836613565
      goupile_default_username: admin
      goupile_default_password: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        34636236643063366163643862626661303264373662376361303837386133383930613362326161
        3331333464643034346466656438383535303461303431650a366262363231626466646438343532
        63626233646666313234353665616433386362616538633339303363333466333934663930653463
        3034363236366438340a373564336135393264636533313464323061356364616361383935393436
        33323139353761396134363130316631633235333761316336613331353132646539
      goupile_smtp:
        url: smtps://mail.gandi.net
        username: noreply@goupile.fr
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30653635353232623035383761656434386562636137613363643635623863656631363363333465
          6566353165653362646363356438626634306330373537360a333366663234313365626463363435
          38616531393632643439363831303563333965396437373834626265353834313430386137363630
          3461323164643435610a336463633930396336613165623139353635376237373831616563653861
          66623264356136343266383135393135653235396165646333336362313931663633
        from: noreply@goupile.fr
      goupile_sms:
        provider: Twilio
        auth_id: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30383036343963313638383266663461373365383138303764613831636230353164373432393839
          6337646336336265343532656561653665333830366565380a653336306164393363383036333430
          32333533356131333865383339336561346139393561663664343461366264353561333763666562
          3433316432353739660a326264383939623737636661623363313534303537623865303137313164
          65633262363039616231323033313164396562633932306161613564326162666230316264646332
          3762343337333933643736626531653236333336363239663433
        auth_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39643532643563313035646233653334373063393934346332646331303732393434373339303966
          3134633530393636313963386565653062616539346261310a313432653536306134393831363661
          32666639656136336638343332386235363939366239623765616239363435376533353033383635
          3665363930336330330a306138326638653535303062613330646164623338636434643336663036
          65326538383062373766396361343234613339313339373737393466333434613332643235386337
          3566346639646238366136333566626531383166303838653465
        from: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61656164316566633739646336636262363065643662643536313934373236616131313466616564
          3331356237353565616135333036393936323133643633320a616234396335396662613533356163
          65303237633438353139623564633436393266326530326532333830656136623165363862333839
          3831306332653033610a626432303566353532333865636133346665353335653833643237363061
          3536

      prometheus_public_addr: '{{ ansible_host }}'
      prometheus_exporters:
        - node_exporter
        - nginx_exporter

    backup:
      ansible_host: 46.226.106.221
      ansible_port: 22
      ansible_user: ansible
      ansible_ssh_private_key_file: ~/.ssh/pknet/prod
      ansible_python_interpreter: /usr/bin/python3

      nginx_public_addr: '{{ ansible_host }}'
      nginx_domains:
        - name: '{{ prometheus_public_addr }}'
          config: |
            ssl_client_certificate /opt/nginx/ssl/internal/ca.crt;
            ssl_verify_client on;
            ssl_verify_depth 2;

            {% for exporter in prometheus_exporters %}

            location /metrics/{{ exporter }} {
                allow {{ hostvars.monitor.nginx_public_addr }};
                deny all;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:{{ prometheus_packages[exporter].port }}/metrics;
            }
            {% endfor %}

      prometheus_public_addr: '{{ ansible_host }}'
      prometheus_exporters:
        - node_exporter
        - nginx_exporter

    monitor:
      ansible_host: 46.226.106.128
      ansible_port: 22
      ansible_user: ansible
      ansible_ssh_private_key_file: ~/.ssh/pknet/prod
      ansible_python_interpreter: /usr/bin/python3

      nginx_public_addr: '{{ ansible_host }}'
      nginx_domains:
        - name: '{{ prometheus_public_addr }}'
          config: |
            ssl_client_certificate /opt/nginx/ssl/internal/ca.crt;
            ssl_verify_client on;
            ssl_verify_depth 2;

            {% for exporter in prometheus_exporters %}

            location /metrics/{{ exporter }} {
                allow {{ hostvars.monitor.nginx_public_addr }};
                deny all;

                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:{{ prometheus_packages[exporter].port }}/metrics;
            }
            {% endfor %}
        - name: monitor.volpil.fr
          ssl_certbot_email: niels.martignene@protonmail.com
          config: |
            limit_req zone=default burst=100 nodelay;

            location /prometheus {
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:9090;
            }

            location / {
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_pass http://127.0.0.1:9200;
            }
        - name: volpil.fr
          ssl_certbot_email: niels.martignene@protonmail.com
          config: |
            location / {
                index index.html;

                rewrite ^(/?[a-zA-Z0-9]+)$ $1.html;
                rewrite ^(/?[a-zA-Z0-9]+)/$ $1 permanent;
                try_files $uri $uri/ =404;

                root /opt/static/live/goupile.fr;
            }
        - name: www.volpil.fr
          ssl_certbot_email: niels.martignene@protonmail.com
          config: |
            location / {
                return 301 https://volpil.fr$request_uri;
            }

      prometheus_public_addr: '{{ ansible_host }}'
      prometheus_exporters:
        - node_exporter
        - nginx_exporter
      prometheus_url: 'https://monitor.volpil.fr/prometheus'
      grafana_url: 'https://monitor.volpil.fr/'

      static_deploys:
        - name: goupile.fr
          repo: https://framagit.org/interhop/goupile
          path: web/goupile.fr
