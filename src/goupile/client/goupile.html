<!DOCTYPE html>
<!--
    This Source Code Form is subject to the terms of the Mozilla Public
    License, v. 2.0. If a copy of the MPL was not distributed with this
    file, You can obtain one at http://mozilla.org/MPL/2.0/.
-->
<html>
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1"/>

        <link rel="icon" href="{BASE_URL}favicon.png" />
        <title>{TITLE}</title>

        <script>
            // Goupile {VERSION}
            // https://goupile.fr/

            var ENV = {ENV_JSON};
        </script>
        <script src="{BASE_URL}static/goupile.pk.js" async></script>
        <link rel="stylesheet" href="{BASE_URL}static/goupile.pk.css" async/>

        <link rel="preload" href="{BASE_URL}static/OpenSans_v17_Latin_Regular.woff2" as="font" type="font/woff2" crossorigin/>
        <link rel="preload" href="{BASE_URL}static/OpenSans_v17_Latin_Bold.woff2" as="font" type="font/woff2" crossorigin/>
        <link rel="preload" href="{BASE_URL}static/OpenSans_v17_Latin_Italic.woff2" as="font" type="font/woff2" crossorigin/>
        <link rel="preload" href="{BASE_URL}static/OpenSans_v17_Latin_BoldItalic.woff2" as="font" type="font/woff2" crossorigin/>

        <style>
            .gp_loading {
                display: flex;
                height: 100%;
                align-items: center;
                justify-content: center;
                visibility: hidden;
                animation: gp_loading_wait 0.2s 1 linear;
                animation-fill-mode: forwards;
                animation-delay: 0.3s;
            }
            .gp_loading::after {
                content: ' ';
                display: block;
                width: 48px;
                height: 48px;
                margin: 1px;
                border-radius: 50%;
                border: 12px solid var(--menu_color);
                border-color: var(--menu_color) transparent var(--menu_color) transparent;
                animation: gp_loading_spinner 0.8s ease-in-out infinite;
            }
            .gp_loading > * { display: none !important; }
            @keyframes gp_loading_wait {
                100% {
                    visibility: visible;
                    background: white;
                }
            }
            @keyframes gp_loading_spinner {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            #gp_logo {
                position: absolute;
                left: calc(50% - 48px);
                margin-top: -64px;
                width: 96px;
                height: 96px;
            }
        </style>

        {HEAD_TAGS}
    </head>

    <body>
        <div id="ui_root">
            <div id="ui_main"></div>
        </div>

        <script>
            try {
                eval('let test = async function() {}');

                // See here: https://github.com/dfahlander/Dexie.js/issues/317
                let m = navigator.userAgent.match('Firefox/([0-9]+)');
                if (m != null) {
                    let version = parseInt(m[1], 10);
                    if (version < 60)
                        throw new Error('Cannot work with broken async in IndexedDB');
                }

                document.body.classList.add('gp_loading');
                window.addEventListener('load', function(e) {
                    let p = goupile.start();

                    p.catch(function(err) {
                        document.querySelector('#ui_main').innerHTML =
                            '<div class="ui_wip">' +
                                '<b>Une erreur est survenue pendant le chargement</b>\n' +
                                err.message +
                            '</div>';
                    });
                    p.finally(function() {
                        document.body.classList.remove('gp_loading');
                    });
                });
            } catch (err) {
                document.querySelector('#ui_main').innerHTML =
                    '<div class="ui_wip">' +
                        '<b>Ce navigateur n\'est pas supporté, ou il s\'agit d\'une version trop ancienne</b>\n' +
                        'Vous pouvez utiliser Chrome (version ≥ 55), Firefox (version ≥ 60), Edge (version ≥ 17), Safari (≥ 11)' +
                    '</div>';
            }
        </script>
        <noscript><div class="ui_wip">Cette application nécessite un support Javascript</div></noscript>
    </body>
</html>
