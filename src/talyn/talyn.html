<!DOCTYPE html>
<html>
    <head>
        <title>Talyn</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <style type="text/css">
            body {
                margin: 0;
                padding: 0;
                font-family: Geneva, sans-serif;
                font-size: 13px;
            }
            div#menu { background: #eeeeee; }

            div#menu nav ul {
                margin: 0;
                padding: 0;
            }
            div#menu nav li { list-style-type: none; }
            div#menu nav a {
                display: block;
                box-sizing: border-box;
                width: 100%;
                padding: 0.5em;
                text-decoration: none;
                color: black;
            }
            div#menu nav a.active {
                background: #262626;
                color: white;
            }
            div#menu nav a:hover:not(.active) {
                background: #ddd !important;
                color: black !important;
            }
            img#logo {
                display: block;
                margin: 1em auto;
            }

            div#pricing nav {
                margin: 0 1em 1em 1em;
                text-align: center;
            }
            div#pricing table {
                width: 100%;
                border-collapse: collapse;
            }
            div#pricing th, div#pricing td {
                border: 1px solid #a4a4a4;
                padding: 3px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                min-width: 68px;
            }
            div#pricing th {
                background: white;
                text-align: left;
                font-style: italic;
                font-weight: normal;
            }
            div#pricing thead td {
                text-align: center;
                font-weight: bold;
            }
            div#pricing tbody td {
                background: #969696;
                text-align: right;
            }
            div#pricing td.desc, div#pricing tr.desc td { background: #ffc634; }
            div#pricing td.conditions, div#pricing tr.conditions td {
                background: #b70202;
                color: white;
            }
            div#pricing td.price, div#pricing tr.price td { background: #68dc33; }
            div#pricing td.exb, div#pricing tr.exb td { background: #ff8900; }
            div#pricing td.exh, div#pricing tr.exh td {
                background: #6b1b6a;
                color: #b4cdff;
            }
            div#pricing td.age, div#pricing tr.age td { background: #99ffff; }

            @media screen and (min-width: 801px) {
                a.deploy { display: none; }

                div#menu {
                    position: fixed;
                    left: 0;
                    top: 0;
                    min-height: 100%;
                    width: 200px;
                }
                div#menu nav a { padding: 0.5em; }

                main {
                    max-width: 800px;
                    margin-left: 200px;
                    padding: 1em;
                }

                div#pricing tr:hover th {
                    filter: invert(100%);
                    -webkit-filter: invert(100%);
                }
                div#pricing tr:hover td {
                    filter: invert(10%);
                    -webkit-filter: invert(10%);
                }
                div#pricing tr:first-child th:first-child { width: 90px; }
            }

            @media screen and (max-width: 800px) {
                body {
                    padding: 0;
                    margin: 0;
                }

                a.deploy {
                    display: block;
                    float: left;
                    width: 42px;
                    height: 40px;
                    margin: 0;
                    padding: 0;
                    background-color: #262626;
                    background-image: url("data:image/gif;base64,R0lGODlhFgAWAIABAP///wAAACH5BAEKAAEALAAAAAAWABYAAAIfhI+py+0PXZi02ouz3rz7b0XiSJYRiKbqyobmC8dNAQA7");
                    background-repeat: no-repeat;
                    background-position: center;
                }

                img#logo { display: none; }
                div#menu {
                    position: fixed;
                    left: 0;
                    top: 0;
                    width: 100%;
                    min-height: 40px;
                    background: #262626;
                    z-index: 10;
                }
                div#menu nav a {
                    height: 40px;
                    padding: 10px 10px 10px 52px;
                    color: white;
                    font-size: 16px;
                }
                div#menu nav a:not(.active) { font-style: italic; }
                div#menu nav:not(.active) a:not(.active) { display: none; }
                div#pricing table { margin-top: 40px; }

                div#pricing nav {
                    position: fixed;
                    left: 0;
                    top: 40px;
                    box-sizing: border-box;
                    width: 100%;
                    padding: 1em;
                    margin: 0;
                    background: #eeeeee;
                }
                div#pricing a.deploy {
                    position: fixed;
                    top: 0;
                    left: calc(100% - 42px);
                    z-index: 20;
                }
                div#pricing nav:not(.active) { display: none; }
                div#pricing nav input, div#pricing nav select { float: right; }
                div#pricing nav label {
                    display: block;
                    height: 30px;
                    text-align: left;
                }

                div#pricing tr:first-child th:first-child { width: 80px; }
                div#pricing tr:first-child th,
                    div#pricing tr:first-child td { border-top: 0; }
                div#pricing tr *:first-child { border-left: 0; }
                div#pricing tr *:last-child { border-right: 0; }
            }
        </style>
        <script>
            var url_base;
            var url_name;

            var ghm_roots = [];
            var ghm_roots_info = {};

            function updateDatabase()
            {
                var date = document.querySelector('input#pricing_date').value;

                downloadJson('api/catalog.json?date=' + date, function(json) {
                    ghm_roots = [];
                    ghm_roots_info = {};

                    for (var i = 0; i < json.length; i++) {
                        ghm_roots.push(json[i].ghm_root);
                        ghm_roots_info[json[i].ghm_root] = json[i].info;
                    }

                    refreshGhmRoots();
                    refreshPricingTable();
                });
            }

            function refreshGhmRoots()
            {
                var el = document.querySelector('select#pricing_ghm_roots');
                var previous_value = el.value;
                el.innerHTML = '';
                for (var i = 0; i < ghm_roots.length; i++) {
                    var opt = document.createElement('option');
                    opt.setAttribute('value', ghm_roots[i]);
                    opt.textContent = ghm_roots[i];
                    el.appendChild(opt);
                }
                if (previous_value)
                    el.value = previous_value;
            }

            function refreshPricingTable()
            {
                var ghm_root_info = ghm_roots_info[document.querySelector('select#pricing_ghm_roots').value];
                var merge_cells = document.querySelector('input#pricing_merge_cells').checked;
                var max_duration = parseInt(document.querySelector('input#pricing_max_duration').value) + 1;

                var table = createPricingTable(ghm_root_info, merge_cells, max_duration);

                var old_table = document.querySelector('div#pricing table');
                old_table.parentNode.replaceChild(table, old_table);
            }

            function createPricingTable(ghm_root_info, merge_cells, max_duration)
            {
                if (merge_cells === undefined)
                    merge_cells = true;
                if (max_duration === undefined)
                    max_duration = 200;

                function appendRow(parent, name, func)
                {
                    var tr =
                        createElement('tr', {},
                            createElement('th', {}, name)
                        );

                    var prev_cell = [document.createTextNode(''), null, false];
                    var prev_td = null;
                    for (var i = 0; i < ghm_root_info.length; i++) {
                        var cell = func(ghm_root_info[i]) || [null, null, false];
                        if (cell[0] === null) {
                            cell[0] = document.createTextNode('');
                        } else if (typeof cell[0] === 'string') {
                            cell[0] = document.createTextNode(cell[0]);
                        }
                        if (merge_cells && cell[2] && cell[0].isEqualNode(prev_cell[0]) && cell[1] == prev_cell[1]) {
                            var colspan = parseInt(prev_td.getAttribute('colspan') || 1);
                            prev_td.setAttribute('colspan', colspan + 1);
                        } else {
                            prev_td = tr.appendChild(createElement('td', {class: cell[1]}, cell[0]));
                        }
                        prev_cell = cell;
                    }

                    parent.appendChild(tr);
                }

                function durationText(duration)
                {
                    if (duration !== undefined) {
                        return duration.toString() + (duration >= 2 ? ' nuits' : ' nuit');
                    } else {
                        return '';
                    }
                }
                function priceText(price_cents)
                {
                    if (price_cents !== undefined) {
                        // The replace() is a bit dirty, but it gets the job done
                        return (price_cents / 100.0).toFixed(2).replace('.', ',');
                    } else {
                        return '';
                    }
                }

                var table =
                    createElement('table', {},
                        createElement('thead'),
                        createElement('tbody')
                    );
                var thead = table.querySelector('thead');
                var tbody = table.querySelector('tbody');

                appendRow(thead, 'GHM', function(col) { return [col.ghm, 'desc', true]; });
                appendRow(thead, 'Niveau', function(col) { return ['Niveau ' + col.ghm_mode, 'desc', true]; });
                appendRow(thead, 'GHS', function(col) { return ['GHS ' + col.ghs, 'desc', true]; });
                appendRow(thead, 'Conditions', function(col) {
                    var el =
                        createElement('div', {title: col.conditions.join('\n')},
                            col.conditions.length ? col.conditions.length.toString() : ''
                        );
                    return [el, 'conditions', true];
                })
                appendRow(thead, 'Borne basse', function(col) { return [durationText(col.exb_treshold), 'exb', true]; });
                appendRow(thead, 'Borne haute',
                          function(col) { return [durationText(col.exh_treshold && col.exh_treshold - 1), 'exh', true]; });
                appendRow(thead, 'Tarif €', function(col) { return [priceText(col.price_cents), 'price', true]; });
                appendRow(thead, 'Forfait EXB €',
                          function(col) { return [col.exb_once ? priceText(col.exb_cents) : '', 'exb', true]; });
                appendRow(thead, 'Tarif EXB €',
                          function(col) { return [!col.exb_once ? priceText(col.exb_cents) : '', 'exb', true]; });
                appendRow(thead, 'Tarif EXH €', function(col) { return [priceText(col.exh_cents), 'exh', true]; });
                appendRow(thead, 'Age', function(col) {
                    var texts = [];
                    if (col.ghm_mode >= '1' && col.ghm_mode < '5') {
                        var severity = col.ghm_mode.charCodeAt(0) - '1'.charCodeAt(0);
                        if (severity < col.young_severity_limit) {
                            texts.push('< ' + col.young_age_treshold.toString());
                        }
                        if (severity < col.old_severity_limit) {
                            texts.push('≥ ' + col.old_age_treshold.toString());
                        }
                    }
                    return [texts.join(', '), 'age', true];
                });

                for (var duration = 0; duration < max_duration; duration++) {
                    appendRow(tbody, durationText(duration), function(col) {
                        if ((col.low_duration_limit && duration < col.low_duration_limit) ||
                            (col.high_duration_limit && duration >= col.high_duration_limit))
                            return null;
                        if (col.exb_treshold && duration < col.exb_treshold) {
                            var price = col.price_cents;
                            if (col.exb_once) {
                                price -= col.exb_cents;
                            } else {
                                price -= (col.exb_treshold - duration) * col.exb_cents;
                            }
                            return [priceText(price), 'exb', false];
                        }
                        if (col.exh_treshold && duration >= col.exh_treshold) {
                            var price = col.price_cents + (duration - col.exh_treshold + 1) * col.exh_cents;
                            return [priceText(price), 'exh', false];
                        }
                        return [priceText(col.price_cents), 'price', false];
                    });
                }

                return table;
            }

            function createElement(tag, attr)
            {
                var el = document.createElement(tag);
                if (attr) {
                    for (var key in attr) {
                        value = attr[key];
                        if (value !== null)
                            el.setAttribute(key, attr[key]);
                    }
                }
                for (var i = 2; i < arguments.length; i++) {
                    if (typeof arguments[i] === 'string') {
                        el.appendChild(document.createTextNode(arguments[i]));
                    } else if (arguments[i] !== null) {
                        el.appendChild(arguments[i]);
                    }
                }
                return el;
            }

            function toggleNav(id)
            {
                var el = document.querySelector('div#' + id + ' nav');
                if (el.classList.contains('active')) {
                    el.classList.remove('active');
                } else {
                    var els = document.querySelectorAll('div nav');
                    for (var i = 0; i < els.length; i++)
                        els[i].classList.toggle('active', els[i] == el);
                }
            }

            function downloadJson(url, func)
            {
                var xhr = new XMLHttpRequest();
                xhr.open('get', url, true);
                xhr.responseType = 'json';
                xhr.onload = function(e) {
                    if (this.status === 200) {
                        func(xhr.response);
                    } else {
                        console.log("Statut de la réponse: %d (%s)", this.status, this.statusText);
                    }
                };
                xhr.send();
            }

            document.addEventListener('DOMContentLoaded', function(e) {
                downloadJson('api/pages.json', function(pages) {
                    if (url_name == '') {
                        url_name = pages[0].url.substr(1);
                        window.history.replaceState(null, null, url_base + '/' + url_name);
                    }

                    var ul = document.querySelector('div#menu nav ul');
                    for (var i = 0; i < pages.length; i++) {
                        var page_url = pages[i].url.substr(1);
                        var li =
                            createElement('li', {},
                                createElement('a', {href: page_url,
                                                    class: page_url == url_name ? 'active' : null}, pages[i].name)
                            );
                        ul.appendChild(li);
                    }
                });

                url_base = window.location.pathname.substr(0, window.location.pathname.lastIndexOf('/'));
                url_name = window.location.pathname.substr(url_base.length + 1);

                var date_input = document.querySelector('input#pricing_date');
                if (!date_input.value) {
                    date_input.valueAsDate = new Date();
                }
                updateDatabase();
            });
        </script>
    </head>
    <body>
        <div id="menu">
            <a class="deploy" href="#" onclick="toggleNav('menu'); return false;"></a>
            <nav>
                <img id="logo" src="resources/logo.png" alt="Moya Logo"/>
                <ul>
                </ul>
            </nav>
        </div>

        <main>
            <div id="pricing">
                <a class="deploy" href="#" onclick="toggleNav('pricing'); return false;"></a>
                <nav>
                    <label>
                        Racine de GHM
                        <select id="pricing_ghm_roots" onchange="refreshPricingTable();"
                                style="width: 7em;"></select>
                    </label>
                    <label>
                        Date
                        <input id="pricing_date" type="date" onchange="updateDatabase();"/>
                    </label>
                    <label>
                        Durée maximale
                        <input id="pricing_max_duration" type="number" onchange="refreshPricingTable();" value="200" min="0" max="500" step="5"/>
                    </label>
                    <label>
                        <input id="pricing_merge_cells" type="checkbox" onchange="refreshPricingTable();" checked/>
                        Fusionner les cellules
                    </label>
                </nav>

                <table></table>
            </div>
        </main>
    </body>
</html>
