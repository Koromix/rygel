<!DOCTYPE html>
<html>
    <head>
        <title>Talyn</title>
        <meta charset="utf-8"/>
        <style type="text/css">
            html {
                /* Fix stupid scrollbar behavior */
                width: calc(100vw - 17px);
            }
            body {
                margin: 0;
                padding: 0;
                font-family: Geneva, sans-serif;
                font-size: 13px;
            }
            nav#menu {
                position: fixed;
                min-height: 100%;
                width: 200px;
                background: #f5f5f5;
            }
            main {
                max-width: 800px;
                margin-left: 200px;
                padding: 1em;
            }

            nav#menu ul {
                margin: 0;
                padding: 0;
            }
            nav#menu li { list-style-type: none; }
            nav#menu li a {
                display: block;
                box-sizing: border-box;
                width: 100%;
                padding: 0.5em;
                text-decoration: none;
                color: black;
            }
            nav#menu li a:hover {
                background: #ddd;
            }
            nav#menu li a.active {
                background: #262626;
                color: white;
            }
            nav#menu img#logo {
                display: block;
                margin: 1em auto;
            }

            nav#pricing_settings {
                margin: 0 1em 1em 1em;
                text-align: center;
            }
            table#pricing_table {
                width: 100%;
                table-layout: fixed;
                border-collapse: collapse;
            }
            table#pricing_table tr:first-child th:first-child { width: 100px; }
            table#pricing_table th, table#pricing_table td {
                border: 1px solid #a4a4a4;
                padding: 3px;
            }
            table#pricing_table th {
                background: white;
                text-align: left;
                font-style: italic;
                font-weight: normal;
            }
            table#pricing_table thead td {
                text-align: center;
                font-weight: bold;
            }
            table#pricing_table tbody td {
                background: #969696;
                text-align: right;
            }
            table#pricing_table tr:hover th {
                filter: invert(100%);
                -webkit-filter: invert(100%);
            }
            table#pricing_table tr:hover td {
                filter: invert(10%);
                -webkit-filter: invert(10%);
            }
            table#pricing_table td.desc, table#pricing_table tr.desc td { background: #ffc634; }
            table#pricing_table td.conditions, table#pricing_table tr.conditions td {
                background: #b70202;
                color: white;
            }
            table#pricing_table td.price, table#pricing_table tr.price td { background: #68dc33; }
            table#pricing_table td.exb, table#pricing_table tr.exb td { background: #ff8900; }
            table#pricing_table td.exh, table#pricing_table tr.exh td {
                background: #6b1b6a;
                color: #b4cdff;
            }
            table#pricing_table td.age, table#pricing_table tr.age td { background: #99ffff; }

            @media screen and (max-width: 580px) {
                body {
                    padding: 0;
                    margin: 0;
                }

                table#pricing_table tr *:first-child { border-left: 0; }
                table#pricing_table tr *:last-child { border-right: 0; }
            }
        </style>
        <script>
            var url_base;
            var url_name;

            var ghm_roots = [];
            var ghm_roots_info = {};

            function updateDatabase() {
                var date = document.querySelector('input#pricing_date').value;

                fetch('api/catalog.json?date=' + date)
                    .then(response => response.json())
                    .then(function(json) {
                        ghm_roots = [];
                        ghm_roots_info = {};

                        for (var i = 0; i < json.length; i++) {
                            ghm_roots.push(json[i].ghm_root);
                            ghm_roots_info[json[i].ghm_root] = json[i].info;
                        }

                        refreshGhmRoots();
                        refreshPricingTable();
                    });
            }

            function refreshGhmRoots() {
                var el = document.querySelector('select#pricing_ghm_roots');
                var previous_value = el.value;
                el.innerHTML = '';
                for (var i = 0; i < ghm_roots.length; i++) {
                    var opt = document.createElement('option');
                    opt.setAttribute('value', ghm_roots[i]);
                    opt.textContent = ghm_roots[i];
                    el.appendChild(opt);
                }
                if (previous_value)
                    el.value = previous_value;
            }

            function refreshPricingTable() {
                var ghm_root_info = ghm_roots_info[document.querySelector('select#pricing_ghm_roots').value];
                var merge_cells = document.querySelector('input#pricing_merge_cells').checked;
                var max_duration = parseInt(document.querySelector('input#pricing_max_duration').value) + 1;

                var table = createPricingTable(ghm_root_info, merge_cells, max_duration);

                var old_table = document.querySelector('table#pricing_table');
                old_table.parentNode.replaceChild(table, old_table);
            }

            function createPricingTable(ghm_root_info, merge_cells = true, max_duration = 200) {
                function appendRow(parent, name, func) {
                    var tr =
                        createElement('tr', {},
                            createElement('th', {}, name)
                        );

                    var prev_cell = [document.createTextNode(''), null, false];
                    var prev_td = null;
                    for (var i = 0; i < ghm_root_info.length; i++) {
                        var cell = func(ghm_root_info[i]) || [null, null, false];
                        if (cell[0] === null) {
                            cell[0] = document.createTextNode('');
                        } else if (typeof cell[0] === 'string') {
                            cell[0] = document.createTextNode(cell[0]);
                        }
                        if (merge_cells && cell[2] && cell[0].isEqualNode(prev_cell[0]) && cell[1] == prev_cell[1]) {
                            var colspan = parseInt(prev_td.getAttribute('colspan') || 1);
                            prev_td.setAttribute('colspan', colspan + 1);
                        } else {
                            prev_td = tr.appendChild(createElement('td', {class: cell[1]}, cell[0]));
                        }
                        prev_cell = cell;
                    }

                    parent.appendChild(tr);
                }

                function durationText(duration) {
                    if (duration !== undefined) {
                        return duration.toString() + (duration >= 2 ? ' nuits' : ' nuit');
                    } else {
                        return '';
                    }
                }
                function priceText(price_cents) {
                    if (price_cents !== undefined) {
                        // The replace() is a bit dirty, but it gets the job done
                        return (price_cents / 100.0).toFixed(2).replace('.', ',');
                    } else {
                        return '';
                    }
                }

                function conditionsContent(conditions) {
                    var el =
                        createElement('div', {title: conditions.join('\n')},
                            conditions.length ? conditions.length.toString() : ''
                        );
                    return el;
                }

                var table =
                    createElement('table', {id: 'pricing_table'},
                        createElement('thead'),
                        createElement('tbody')
                    );
                var thead = table.querySelector('thead');
                var tbody = table.querySelector('tbody');

                appendRow(thead, 'GHM', function(col) { return [col.ghm, 'desc', true]; });
                appendRow(thead, 'Niveau', function(col) { return ['Niveau ' + col.ghm_mode, 'desc', true]; });
                appendRow(thead, 'GHS', function(col) { return ['GHS ' + col.ghs, 'desc', true]; });
                appendRow(thead, 'Conditions',
                          function(col) { return [conditionsContent(col.conditions), 'conditions', true]; })
                appendRow(thead, 'Borne basse', function(col) { return [durationText(col.exb_treshold), 'exb', true]; });
                appendRow(thead, 'Borne haute',
                          function(col) { return [durationText(col.exh_treshold && col.exh_treshold - 1), 'exh', true]; });
                appendRow(thead, 'Tarif €', function(col) { return [priceText(col.price_cents), 'price', true]; });
                appendRow(thead, 'Forfait EXB €',
                          function(col) { return [col.exb_once ? priceText(col.exb_cents) : '', 'exb', true]; });
                appendRow(thead, 'Tarif EXB €',
                          function(col) { return [!col.exb_once ? priceText(col.exb_cents) : '', 'exb', true]; });
                appendRow(thead, 'Tarif EXH €', function(col) { return [priceText(col.exh_cents), 'exh', true]; });

                for (var duration = 0; duration < max_duration; duration++) {
                    appendRow(tbody, durationText(duration), function(col) {
                        if ((col.low_duration_limit && duration < col.low_duration_limit) ||
                            (col.high_duration_limit && duration >= col.high_duration_limit))
                            return null;
                        if (col.exb_treshold && duration < col.exb_treshold) {
                            var price = col.price_cents;
                            if (col.exb_once) {
                                price -= col.exb_cents;
                            } else {
                                price -= (col.exb_treshold - duration) * col.exb_cents;
                            }
                            return [priceText(price), 'exb', false];
                        }
                        if (col.exh_treshold && duration >= col.exh_treshold) {
                            var price = col.price_cents + (duration - col.exh_treshold + 1) * col.exh_cents;
                            return [priceText(price), 'exh', false];
                        }
                        return [priceText(col.price_cents), 'price', false];
                    });
                }

                return table;
            }

            function createElement(tag, attr) {
                var el = document.createElement(tag);
                if (attr) {
                    for (var key in attr) {
                        value = attr[key];
                        if (value !== null)
                            el.setAttribute(key, attr[key]);
                    }
                }
                for (var i = 2; i < arguments.length; i++) {
                    if (typeof arguments[i] === 'string') {
                        el.appendChild(document.createTextNode(arguments[i]));
                    } else if (arguments[i] !== null) {
                        el.appendChild(arguments[i]);
                    }
                }
                return el;
            }

            document.addEventListener('DOMContentLoaded', function(e) {
                fetch('api/pages.json')
                    .then(response => response.json())
                    .then(function(pages) {
                        if (url_name == '') {
                            url_name = pages[0].url.substr(1);
                            window.history.replaceState(null, null, url_base + '/' + url_name);
                        }

                        var ul = document.querySelector('#menu ul');
                        for (var i = 0; i < pages.length; i++) {
                            var page_url = pages[i].url.substr(1);
                            var li =
                                createElement('li', {},
                                    createElement('a', {href: page_url,
                                                        class: page_url == url_name ? 'active' : null}, pages[i].name)
                                );
                            ul.appendChild(li);
                        }
                    });

                url_base = window.location.pathname.substr(0, window.location.pathname.lastIndexOf('/'));
                url_name = window.location.pathname.substr(url_base.length + 1);

                var date_input = document.querySelector('input#pricing_date');
                if (!date_input.value) {
                    date_input.valueAsDate = new Date();
                }
                updateDatabase();
            });
        </script>
    </head>
    <body>
        <nav id="menu">
            <img id="logo" src="resources/logo.png" alt="Moya Logo"/>
            <ul>
            </ul>
        </nav>

        <main>
            <div id="pricing">
                <nav id="pricing_settings">
                    <label>
                        Date :
                        <input id="pricing_date" type="date" onchange="updateDatabase();"/>
                    </label>
                    <label>
                        Racine de GHM :
                        <select id="pricing_ghm_roots" onchange="refreshPricingTable();"
                                style="width: 7em;"></select>
                    </label>
                    <label>
                        Durée maximale :
                        <input id="pricing_max_duration" type="number" onchange="refreshPricingTable();" value="200" min="0" max="500" step="5"/>
                    </label>
                    <label>
                        <input id="pricing_merge_cells" type="checkbox" onchange="refreshPricingTable();" checked/>
                        Fusionner les cellules
                    </label>
                </nav>

                <table id="pricing_table"></table>
            </div>
        </main>
    </body>
</html>
