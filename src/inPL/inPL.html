<!DOCTYPE html>
<html>
    <head>
        <title>Tableaux PL</title>
        <meta charset="UTF-8"/>

        <link rel="stylesheet" href="inPL.css"/>

        <script type="text/javascript" src="../../lib/papaparse/papaparse.min.js"></script>
        <script type="text/javascript" src="../libweb/compat.js"></script>
        <script type="text/javascript" src="../libweb/util.js"></script>
        <script type="text/javascript" src="common.js"></script>
        <script type="text/javascript" src="bridge.js"></script>
        <script type="text/javascript" src="ems.js"></script>
        <script type="text/javascript" src="neuropsy.js"></script>
        <script type="text/javascript" src="nutrition.js"></script>

        <script type="text/javascript">
            function openTab(tabbar, container, idx)
            {
                let tabs = tabbar.querySelectorAll('button');
                let pages = container.querySelectorAll('.inpl_tabpage');

                tabs.removeClass('active');
                tabs[idx].addClass('active');
                pages.removeClass('active');
                pages[idx].addClass('active');
            }

            function refreshTables()
            {
                let file = document.querySelector('#inpl_file').files[0];
                let dashboard = document.querySelector('#inpl_dashboard');

                if (file) {
                    dashboard.replaceContent(
                        html('thead',
                            html('tr',
                                html('th', {rowspan: 2}, 'PLID'),
                                html('th', {colspan: 8}, 'Neuropsychologie'),
                                html('th', {colspan: 5}, 'Nutrition'),
                                html('th', {colspan: 4}, 'EMS')
                            ),
                            html('tr',
                                html('th', {title: 'Efficience'}, 'EFF'),
                                html('th', {title: 'Mémoire'}, 'MEM'),
                                html('th', {title: 'Exécution'}, 'EXE'),
                                html('th', {title: 'Attention'}, 'ATT'),
                                html('th', {title: 'Cognition'}, 'COG'),
                                html('th', {title: 'Dépression / Anxiété'}, 'DA'),
                                html('th', {title: 'Sommeil'}, 'SOM'),
                                html('th', {title: 'Neuropsychologie'}, 'NP'),
                                html('th', {title: 'Diversité'}, 'DIV'),
                                html('th', {title: 'Protéines'}, 'PRO'),
                                html('th', {title: 'Calcium'}, 'CAL'),
                                html('th', {title: 'Comportement'}, 'CMP'),
                                html('th', {title: 'Nutrition'}, 'NUT'),
                                html('th', {title: 'Mobilité'}, 'MOB'),
                                html('th', {title: 'Force'}, 'FOR'),
                                html('th', {title: 'Risque de fracture'}, 'RF'),
                                html('th', {title: 'EMS'}, 'EMS')
                            )
                        ),
                        html('tbody')
                    );

                    let tbody = dashboard.querySelector('tbody');

                    function resultCell(result)
                    {
                        switch (result) {
                            case ScreeningResult.Bad: return html('td', {class: 'inpl_result_1', title: 'Pathologique'}, 'P');
                            case ScreeningResult.Fragile: return html('td', {class: 'inpl_result_2', title: 'Fragile'}, 'F');
                            case ScreeningResult.Good: return html('td', {class: 'inpl_result_3', title: 'Robuste'}, 'R');
                            default: return html('td', {class: 'inpl_result_0', title: 'Indéfini'}, '?');
                        }
                    }

                    bridge.readFromFile(file, row => {
                        let tr = html('tr',
                            html('th', '' + row.plid),
                            resultCell(neuropsy.screenEfficiency(row)),
                            resultCell(neuropsy.screenMemory(row)),
                            resultCell(neuropsy.screenExecution(row)),
                            resultCell(neuropsy.screenAttention(row)),
                            resultCell(neuropsy.screenCognition(row)),
                            resultCell(neuropsy.screenDepressionAnxiety(row)),
                            resultCell(neuropsy.screenSleep(row)),
                            resultCell(neuropsy.screenAll(row)),
                            resultCell(nutrition.screenDiversity(row)),
                            resultCell(nutrition.screenProteinIntake(row)),
                            resultCell(nutrition.screenCalciumIntake(row)),
                            resultCell(nutrition.screenBehavior(row)),
                            resultCell(nutrition.screenAll(row)),
                            resultCell(ems.screenMobility(row)),
                            resultCell(ems.screenStrength(row)),
                            resultCell(ems.screenFractureRisk(row)),
                            resultCell(ems.screenAll(row))
                        );

                        tbody.appendContent(tr);
                    });
                } else {
                    dashboard.innerHTML = '';
                }
            }

            window.addEventListener('load', function() {
                refreshTables();
                openTab(document.querySelector('#inpl_menu'), document.body, 0);
            });
        </script>
    </head>

    <body>
        <div id="inpl_menu" class="inpl_tabbar">
            <button onclick="openTab(this.parentNode, document.body, 0);">Synthèse</button>
            <button onclick="openTab(this.parentNode, document.body, 1);">Consultants</button>
            <button onclick="openTab(this.parentNode, document.body, 2);">Résumés</button>

            <input id="inpl_file" type="file" accept=".csv" onchange="refreshPage();" />
        </div>

        <div class="inpl_tabpage"></div>
        <div class="inpl_tabpage">
            <table id="inpl_dashboard"></table>
        </div>
        <div class="inpl_tabpage"></div>
    </body>
</html>
