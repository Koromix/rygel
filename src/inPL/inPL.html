<!DOCTYPE html>
<html>
    <head>
        <title>Tableau de bord PL</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1"/>

        <link rel="stylesheet" href="inPL.css"/>

        <script type="text/javascript" src="../../lib/papaparse/papaparse.min.js"></script>
        <script type="text/javascript" src="../../lib/docxtemplater/jszip.min.js"></script>
        <script type="text/javascript" src="../../lib/docxtemplater/docxtemplater.min.js"></script>
        <script type="text/javascript" src="../libweb/compat.js"></script>
        <script type="text/javascript" src="../libweb/util.js"></script>
        <script type="text/javascript" src="common.js"></script>
        <script type="text/javascript" src="mod_ems.js"></script>
        <script type="text/javascript" src="mod_neuropsy.js"></script>
        <script type="text/javascript" src="mod_nutrition.js"></script>
        <script type="text/javascript" src="bridge.js"></script>
        <script type="text/javascript" src="report.js"></script>
        <script type="text/javascript" src="tables.js"></script>

        <script type="text/javascript">
            let rows = [];

            function openTab(tabbar, container, idx)
            {
                let tabs = tabbar.querySelectorAll('button');
                let pages = container.querySelectorAll('.inpl_tabpage');

                tabs.removeClass('active');
                tabs[idx].addClass('active');
                pages.removeClass('active');
                pages[idx].addClass('active');
            }

            function importAndRefresh()
            {
                let file = document.querySelector('#inpl_menu_file').files[0];

                let stat = document.querySelector('#inpl_menu_stat');

                rows.length = 0;
                if (file) {
                    bridge.readFileAsync(file, {
                        step: row => {
                            rows.push(row);
                        },
                        complete: () => {
                            rows.sort((row1, row2) => row1.plid - row2.plid);

                            stat.replaceContent(`(${rows.length} rendez-vous chargés)`);

                            tables.refreshList(rows, (plid) => {
                                query('#inpl_option_plid').value = plid;
                                report.refreshReport(rows);
                                openTab(query('#inpl_menu'), document.body, 2);
                            });
                            tables.refreshSummary(rows);
                            report.refreshReport(rows);
                        }
                    });
                } else {
                    stat.innerHTML = '';

                    tables.refreshList(rows);
                    tables.refreshSummary(rows);
                    report.refreshReport(rows);
                }
            }

            window.addEventListener('load', function() {
                importAndRefresh();
                openTab(document.querySelector('#inpl_menu'), document.body, 0);
            });
        </script>
    </head>

    <body>
        <div id="inpl_menu" class="inpl_tabbar">
            <button onclick="openTab(this.parentNode, document.body, 0);">Résultats</button>
            <button onclick="openTab(this.parentNode, document.body, 1);">Synthèse</button>
            <button onclick="openTab(this.parentNode, document.body, 2);">Consultants</button>

            <input id="inpl_menu_file" type="file" accept=".csv" onchange="importAndRefresh();"/>
            <span id="inpl_menu_stat"></span>
        </div>

        <div class="inpl_tabpage">
            <table id="inpl_list" class="inpl_table"></table>
        </div>

        <div class="inpl_tabpage">
            <div class="inpl_options">
                <label>Sexe :
                    <select id="inpl_option_sex" onchange="tables.refreshSummary(rows);">
                        <option value="all">Tout</option>
                        <option value="male">Hommes</option>
                        <option value="female">Femmes</option>
                    </select>
                </label>
                <label>Lignes :
                    <select id="inpl_option_rows" onchange="tables.refreshSummary(rows);">
                        <option value="age">Âge (classes)</option>
                        <option value="sex">Sexe</option>
                    </select>
                </label>
            </div>

            <table id="inpl_summary" class="inpl_table"></table>
        </div>

        <div class="inpl_tabpage">
            <div class="inpl_options">
                <label>PLID :
                    <input id="inpl_option_plid" type="number"
                           style="-webkit-appearance: none; -moz-appearance: textfield;"
                           oninput="report.refreshReport(rows);"/>
                </label>
                <label>Modèle :
                    <input id="inpl_option_template" type="file" accept=".docx"/>
                </label>
            </div>

            <div id="inpl_report"></div>

            <button style="display: block; margin: 0 auto;">Générer un Compte-Rendu</button>
        </div>
    </body>
</html>
