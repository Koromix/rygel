<!DOCTYPE html>
<html>
    <head>
        <title>VCAP test</title>
        <style>
            html { height: 100%; }

            body {
                display: flex;
                margin: 0;
                padding: 0;
                height: 100%;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-family: sans-serif;
                font-size: 18px;
                gap: 1em;
            }

            button {
                border-radius: 3px;
                background: #262626;
                border: 1px solid #444;
                padding: 0.5em 1em;
                color: white;
                cursor: pointer;
            }
            button:disabled {
                opacity: 0.5;
                cursor: default;
            }

            #playback {
                width: 640px;
                height: 480px;
                background: #ddd;
            }
        </style>
    </head>
    <body>
        <div id="controls">
            <button id="record" onclick="record()">Record</button>
            <button id="stop" onclick="stop()" disabled>Stop</button>
        </div>
        <video id="playback" autoplay></video>

        <script>
            const MIMETYPE = 'video/webm; codecs="vp8, opus"';

            let stream = null;
            let recorder = null;

            let ws = null;

            let queue = null;
            let src = null;
            let buf = null;

            async function record() {
                if (stream != null)
                    throw new Error('Recording in progress');

                document.querySelector('#record').disabled = true;

                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    recorder = new MediaRecorder(stream, { type: MIMETYPE });

                    recorder.ondataavailable = (e) => {
                        if (typeof e.data === 'undefined')
                            return;
                        if (e.data.size === 0)
                            return;

                        ws.send(e.data);
                    };

                    ws = await new Promise((resolve, reject) => {
                        let ws = new WebSocket('/save');

                        ws.addEventListener('open', () => resolve(ws));
                        ws.addEventListener('error', e => reject('Failed WebSocket connection'));
                    });
                    ws.onmessage = async e => {
                        if (buf != null && !buf.updating) {
                            buf.appendBuffer(e.data);
                        } else {
                            queue.push(e.data);
                        }
                    };
                    ws.binaryType = 'arraybuffer';

                    queue = [];
                    src = new MediaSource;
                    src.addEventListener('sourceopen', () => {
                        buf = src.addSourceBuffer(MIMETYPE);

                        buf.addEventListener('updateend', () => {
                            if (!queue.length)
                                return;
                            if (buf.updating)
                                return;

                            buf.appendBuffer(queue.shift());
                        });
                    });

                    recorder.start(1);
                } catch (err) {
                    throw err;
                }

                document.querySelector('#stop').disabled = false;
                document.querySelector('#playback').src = URL.createObjectURL(src);
            }

            async function stop() {
                document.querySelector('#stop').disabled = true;

                if (recorder != null) {
                    recorder.stop();
                    await new Promise((resolve, reject) => { recorder.onstop = () => resolve(); });

                    recorder = null;
                }
                if (stream != null) {
                    for (let track of stream.getTracks())
                        track.stop();

                    stream = null;
                }

                if (ws != null) {
                    ws.close();
                    ws = null;
                    queue = null;
                }

                if (src != null) {
                    src.endOfStream();
                    src = null;
                    buf = null;
                }

                document.querySelector('#record').disabled = false;
                document.querySelector('#playback').src = '';
            }
        </script>
    </body>
</html>
