<!DOCTYPE html>
<!--
    This Source Code Form is subject to the terms of the Mozilla Public
    License, v. 2.0. If a copy of the MPL was not distributed with this
    file, You can obtain one at http://mozilla.org/MPL/2.0/.
-->
<html>
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1"/>

        <title>goupil autoform</title>

        <script src="{BASE_URL}static/ace.js"></script>
        <script src="{BASE_URL}static/goupil.pk.js"></script>
        <script>
            let autoform;

            function refreshAndSave() {
                let editor = ace.edit('af_editor');
                let script = editor.getValue();

                if (autoform.update(script))
                    sessionStorage.setItem('goupil_autoform_script', script);
            }

            function initAutoForm() {
                let root = document.querySelector('#af_page');
                autoform = new AutoForm(root);
            }

            function initEditor() {
                let editor = ace.edit('af_editor');

                editor.setTheme('ace/theme/monokai');
                editor.setShowPrintMargin(false);
                editor.setFontSize(12);
                editor.session.setMode('ace/mode/javascript');

                let script = sessionStorage.getItem('goupil_autoform_script');
                if (script == null) {
                    script = `// Test autoform script

page("aq", "Auto-questionnaire", form => {
    form.text("name", "Quel est votre nom ?");
    form.number("age", "Quel est votre âge ?", {min: 0, max: 120,
                                                suffix: value => (value === 0 || value === 1) ? "an" : "ans"});

    let sexe = form.choice("sexe", "Quel est votre sexe ?", [["M", "Homme"], ["F", "Femme"]]);

    form.dropdown("csp", "Quelle est votre CSP ?", [
        [1, "Agriculteur exploitant"],
        [2, "Artisan, commerçant ou chef d'entreprise"],
        [3, "Cadre ou profession intellectuelle supérieure"],
        [4, "Profession intermédiaire"],
        [5, "Employé"],
        [6, "Ouvrier"],
        [7, "Retraité"],
        [8, "Autre ou sans activité professionnelle"]
    ]);

    form.radio("lieu_vie", "Quel est votre lieu de vie ?", [
        ["maison", "Maison"],
        ["appartement", "Appartement"]
    ]);

    form.multi("sommeil", "Présentez-vous un trouble du sommeil ?", [
        [1, "Troubles d’endormissement"],
        [2, "Troubles de maintien du sommeil"],
        [3, "Réveil précoce"],
        [4, "Sommeil non récupérateur"],
        [null, "Aucune de ces réponses"]
    ]);

    if (sexe.value == "F") {
        form.boolean("enceinte", "Êtes-vous enceinte ?");
    }

    form.section("Alcool", () => {
        let alcool = form.boolean("alcool", "Consommez-vous de l'alcool ?");

        if (alcool.value && form.value("enceinte")) {
            alcool.error("Pensez au bébé...");
            alcool.error("On peut mettre plusieurs erreurs");
            form.error("alcool", "Et de plein de manières différentes !");
        }

        if (alcool.value) {
            form.number("alcool_qt", "Combien de verres par semaine ?", {min: 1, max: 30});
        }
    });

    form.section("Autres", () => {
        form.number("enfants", "Combien avez-vous d'enfants ?", {min: 0, max: 30});
        form.boolean("frites", "Aimez-vous les frites ?",
                     {help: "Si si, c'est important, je vous le jure !"});
    });

    form.output(html\`On peut aussi mettre du <b>HTML directement</b> si on veut...
                  <button class="af_button" @click=\${e => go("aide")}>Afficher l'aide</button>\`);
    form.output("Ou bien encore mettre du <b>texte brut</b>.");
});

page("aide", "Aide", form => {
    form.output("Loreum ipsum");
    form.buttons([
        ["Donner l'alerte", () => alert("Alerte générale !!")],
        ["Revenir à l'auto-questionnaire", () => go("aq")]
    ]);
});
`;
                }
                editor.setValue(script);
                editor.clearSelection();

                editor.on('change', e => {
                    // If something goes wrong during refreshAndSave(), we don't
                    // want to break ACE state.
                    setTimeout(refreshAndSave, 0);
                });
            }

            document.addEventListener('readystatechange', function() {
                if (document.readyState === 'complete') {
                    initAutoForm();
                    initEditor();

                    refreshAndSave();
                }
            });
        </script>

        <link rel="stylesheet" href="{BASE_URL}static/goupil.pk.css"/>
    </head>

    <body>
        <nav id="gp_menu">
            <a class="active" href="{BASE_URL}autoform">Formulaire</a>
            <a href="{BASE_URL}schedule">Agenda</a>
        </nav>

        <main>
            <div id="af_editor"></div>
            <div id="af_page"></div>
        </main>
    </body>
</html>
