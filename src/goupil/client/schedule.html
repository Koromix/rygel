<!DOCTYPE html>
<!--
    This Source Code Form is subject to the terms of the Mozilla Public
    License, v. 2.0. If a copy of the MPL was not distributed with this
    file, You can obtain one at http://mozilla.org/MPL/2.0/.
-->
<html>
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1"/>

        <title>goupil schedule</title>

        <link rel="stylesheet" href="{BASE_URL}static/goupil.pk.css"/>
        <script src="{BASE_URL}static/goupil.pk.js"></script>

        <script>
            let resources = {
                '2019-04-01': [
                    {time: 730, slots: 1, overbook: 0},
                    {time: 1130, slots: 1, overbook: 3}
                ],
                '2019-04-02': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 1, overbook: 1}
                ],
                '2019-04-03': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-04': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-05': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-06': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-08': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-09': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-10': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-11': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-12': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-13': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],

                '2019-04-15': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-16': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-17': [
                    {time: 730, slots: 2, overbook: 0}
                ],
                '2019-04-18': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-19': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-20': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],

                '2019-04-22': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-23': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-24': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-25': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-26': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-27': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],

                '2019-04-29': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ],
                '2019-04-30': [
                    {time: 730, slots: 2, overbook: 0},
                    {time: 1130, slots: 2, overbook: 1}
                ]
            };
            let meetings = {
                '2019-04-01': [
                    {time: 730, identity: 'Clark KENT'},
                    {time: 730, identity: 'Lex LUTHOR'},
                    {time: 1130, identity: 'Lois LANE'}
                ],
                '2019-04-02': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-03': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-04': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-05': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-06': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-08': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-09': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-10': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-11': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-12': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-13': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-14': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-15': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-16': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-17': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-18': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-19': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-20': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-22': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-23': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-24': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-25': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-26': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ],
                '2019-04-27': [
                    {time: 730, identity: 'Gwen STACY'},
                    {time: 730, identity: 'Peter PARKER'},
                    {time: 1130, identity: 'Mary JANE'},
                ]
            };

            // Load schedule changes
            function loadScheduleData(name) {
                if (/^schedule\:[0-9]{4}\-[0-9]{2}\-[0-9]{2}\:(resources|meetings)$/.test(name)) {
                    try {
                        let [_, key, type] = name.split(':');
                        let value = JSON.parse(localStorage.getItem(name));

                        switch (type) {
                            case 'resources': { resources[key] = value; } break;
                            case 'meetings': { meetings[key] = value; } break;
                        }
                    } catch (err) {
                        console.log(err);
                        localStorage.removeItem(name);
                    }
                }
            }
            for(let i = 0; i < localStorage.length; i++) {
                let name = localStorage.key(i);
                loadScheduleData(name);
            }

            document.addEventListener('readystatechange', function() {
                if (document.readyState === 'complete') {
                    let schedule = new Schedule(document.querySelector('#bb_schedule'), resources, meetings);

                    // TODO: This is a basic but stupid way to replicate changes, when we move
                    // to actually replication over the air, we will need to apply changes with a
                    // merge algorithm to limit risk of erasing local changes.
                    window.addEventListener('storage', e => {
                        if (e.storageArea === localStorage) {
                            // FIXME: This may wreck drag-and-drop (assuming D&D does not prevent
                            // this event from occuring) because the slot_ref thing uses array
                            // indexes to perform changes.
                            loadScheduleData(e.key);
                            schedule.render();
                        }
                    });

                    // Save schedule changes
                    schedule.changeResourcesHandler = (key, resources) => {
                        localStorage.setItem(`schedule:${key}:resources`, JSON.stringify(resources));
                    };
                    schedule.changeMeetingsHandler = (key, meetings) => {
                        localStorage.setItem(`schedule:${key}:meetings`, JSON.stringify(meetings));
                    };

                    schedule.render(2019, 4);
                }
            });
        </script>
    </head>
    <body>
        <nav id="bb_menu">
            <a href="X">Consultants</a>
            <a class="active" href="test_schedule.html">Agenda</a>
            <a href="Z">Rapports</a>
        </nav>
        <div id="bb_schedule"></div>
    </body>
</html>
